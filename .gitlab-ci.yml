# Node docker image on which this would be run
image: node:8.9.4

# This command is run before actual stages start running
# before_script:
#   - '( apt-get update -y && apt-get install openssh-client -y )'
#   - npm install

stages:
  - test
  - deploy

# Job 1:
#build:
#  stage: build
#  artifacts:
  #  name: "$CI_JOB_NAME-$CI_COMMIT_SHA"
  #  paths:
  #    -./
#  script:
#    - npm install

deployToQA:
  stage: deploy
  script:
    - echo "====== Deploy to production server ======"
    - apt-get update && apk upgrade
    - apt-get install git openssh bash
    # Add target server`s secret key
    - mkdir ~/.ssh
    - echo $PRIVATE_KEY > ~/.ssh/id_rsa
    - chmod 700 ~/.ssh && chmod 600 ~/.ssh/*
    - echo "Test ssh connection"
    - ssh -o StrictHostKeyChecking=no -T "ubuntu@QA_SERVER"
    # Delploy
    - git clone -b $CI_COMMIT_REF_NAME $CI_REPOSITORY_URL
    - cd $CI_PROJECT_NAME 
    - pm2 remove $CI_PROJECT_NAME || true
    - pm2 start --name $CI_PROJECT_NAME npm -- start
